<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link href="../public/styles/style.css" rel="stylesheet">
      <title>Web Wizards</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200;400;700&display=swap" rel="stylesheet">
      <script src="../public/scripts/notification.js" defer></script>
     <!--  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" >
     <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>-->
   </head>
   <body>
      <!-- Nav Bar -->
      <header>
         <script src="https://kit.fontawesome.com/20313c72b7.js" crossorigin="anonymous"></script>
         <div class="header-content">
            <!-- Size up the logo -->
            <div class="logo">
               <img src="../public/images/Crossfire_Logo_no_bkgd.png" alt="An image of Crossfire Logo">
            </div>
            <div>
                  <button class="notification" id="btnNotification">
                     <span class="fa-solid fa-bell"></span>
                    <span class="badge" id="notification-count">0</span>
                  </button>
            </div>
            <!-- Notification Modal -->
<div id="notification-modal" class="modal">
   <!-- Modal content -->
   <div class="modal-content" id="notification-content">
     <span class="close">&times;</span>
   </div>
 </div>
            <div>
               <nav class="header-nav">
                  <button id="btnNavHome" tabindex="2">Home</button>
                  <button id="btnNavCreateNCR" tabindex="3">Create NCR</button>
                  <button id="btnNavNCRs" tabindex="4">NCR Logs</button>
               </nav>
            </div>
         </div>
      </header>
      <!-- Create Form -->
      <div class="form-container">
         <h2>Non-Conformance Report</h2>
         <form onsubmit="event.preventDefault();">
            <div class="view-container">
               <!-- Fields for Quality Assurance Form -->
               <div id="normView" class="view create">
                  <fieldset>
                     <legend>Quality Representative</legend>
                     
                      <table>
                        <tr>
                           <td>
                              <select id="SupplierID" name="SupplierID" style="width: 300px;" required>
                                 <option value="" disabled selected>Select a supplier</option>
                           </td>
                        </tr>
                        <!-- Item Description -->
                        <tr>
                           <td>
                              <label for="ProductID">Product Name:</label>
                           </td>
                           <td>
                              <select id="ProductID" name="ProductID" style="width: 300px;" disabled required>
                                 <option value="" disabled selected>Select an item</option>
                              </select>
                           </td>
                        </tr>
                        <!-- Defect Description -->
                        <tr>
                           <td>
                              <label for="Details">Description of Defect:</label> <br>
                           </td>
                           <td>
                              <textarea id="Details" name="Details" rows="4" required></textarea>
                           </td>
                        </tr>
                        <!-- Quantity Fields -->
                        <tr>
                           <td>
                              <label for="QuantityReceived">Quantity Received:</label>
                           </td>
                           <td>
                              <input type="number" id="QuantityReceived" name="QuantityReceived" min="1" required>
                           </td>
                        </tr>
                        <tr>
                           <td>
                              <label for="QuantityDefective">Quantity Defective:</label>
                           </td>
                           <td>
                              <input type="number" id="QuantityDefective" name="QuantityDefective" min="0" required>
                           </td>
                        </tr>
                        <!-- Identify Process Applicable -->
                        <tr>
                           <td>
                              <label>Identify Process Applicable:</label>
                           </td>
                           <td>
                              <input type="checkbox" id="WorkInProgress" name="WorkInProgress" />
                        <label for="WorkInProgress">WIP</label>
                        <input type="checkbox" id="SRInspection" name="SRInspection" />
                        <label for="SRInspection">Supplier or Receiving Inspection</label>
                           </td>
                        </tr>
                        <!-- Is Non-Conformance -->
                        <tr>
                           <td>
                              <label for="IsNonConforming">Is Non-Conformance:</label>
                           </td>
                           <td>
                              <input type="checkbox" id="IsNonConforming" name="IsNonConforming">
                           </td>
                        </tr>
                      </table> 
                  </fieldset>
               </div>
            </div>
            <!-- Submit Button -->
            <br>
            <button type="submit">Create NCR</button>
         </form>
      </div>
      <!--<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script> -->
     <!-- <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script> -->
      <script type="module">
         import * as lookup from '../public/scripts/lookup.js';
         
         // Fetch product data



document.addEventListener('DOMContentLoaded', () => {
   lookup.fillForm();


   const form = document.querySelector("form");

form.addEventListener("submit", async (event) => {
const product = document.getElementById("ProductID");

console.log(product.options[product.selectedIndex].text);
console.log(product.options[product.selectedIndex].value);
    const dataToInsert = { 
        SRInspection: document.getElementById("SRInspection").checked,
        WorkInProgress: document.getElementById("WorkInProgress").checked,
        ItemDescription: product.options[product.selectedIndex].text,
        QuantityReceived: parseInt(document.getElementById("QuantityReceived").value, 10),
        QuantityDefective: parseInt(document.getElementById("QuantityDefective").value, 10),
        IsNonConforming: document.getElementById("IsNonConforming").checked,  
        Details: document.getElementById("Details").value,
        ProductID: parseInt(product.value, 10),
    };

    dataToInsert.WorkInProgress = dataToInsert.WorkInProgress ? 1 : 0;
    dataToInsert.SRInspection = dataToInsert.SRInspection ? 1 : 0;
    dataToInsert.IsNonConforming = dataToInsert.IsNonConforming ? 1 : 0;

    try {
        const response = await fetch("http://localhost:5500/insert-quality", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToInsert)
        });

        if (response.ok) {
         const response2 = await fetch('http://localhost:5500/recent-ncrs');
      const data = await response2.json();
       
         console.log(data[0]);

            alert("Data inserted successfully!");
         
           newNotification(JSON.stringify(data[0]), "Quality");
        } else {
            const errorData = await response.text();
            alert(`Failed to save data: ${errorData}`);
        }
    } catch (error) {
        console.error("Error:", error);
        alert("An unexpected error occurred." + error);
    }
});
});
      </script>
      <script src="../public/scripts/navigate.js"></script>
      
      <!--
        </script> HTML: The select element is enhanced with the class="js-example-basic-single" to apply the Select2 functionality.
         CSS: The Select2 library’s CSS is included via a CDN link.
         JavaScript: jQuery and Select2 libraries are included via CDN links. The script initializes the Select2 plugin on the select element when the document is ready.
         HTML: The select element is divided into two optgroup elements. The first group, labeled “Popular Options,” contains the most popular items (Options 5, 10, and 11). 
         The second group, labeled “All Options,” contains all the options, including the popular ones for completeness.
         -->
   </body>
</html>